From 59492aff769abc5207dcb50faf538e287df48ece Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Wed, 19 Nov 2025 20:50:28 +0000
Subject: [PATCH 1/3] Add version 3 multi-segment file format support to sim65

Extended sim65 to support loading code at multiple memory addresses,
which is needed for simulating ROM routines at specific addresses.

Version 3 format:
- Header includes segment count instead of single load address
- Each segment specifies its own load address and length
- Allows placing code at arbitrary addresses (e.g., , )

Backward compatible - still supports version 2 single-segment format.
---
 src/sim65/main.c | 103 +++++++++++++++++++++++++++++++++++++----------
 1 file changed, 82 insertions(+), 21 deletions(-)

diff --git a/src/sim65/main.c b/src/sim65/main.c
index 3cc9581b5..37e87895c 100644
--- a/src/sim65/main.c
+++ b/src/sim65/main.c
@@ -79,6 +79,7 @@ static const unsigned char HeaderSignature[] = {
 #define HEADER_SIGNATURE_LENGTH (sizeof(HeaderSignature)/sizeof(HeaderSignature[0]))
 
 static const unsigned char HeaderVersion = 2;
+static const unsigned char HeaderVersionMultiSeg = 3;
 
 
 /*****************************************************************************/
@@ -209,7 +210,8 @@ static unsigned char ReadProgramFile (void)
     }
 
     /* Get header version */
-    if ((Version = fgetc(F)) != HeaderVersion) {
+    Version = fgetc(F);
+    if (Version != HeaderVersion && Version != HeaderVersionMultiSeg) {
         Error ("'%s': Invalid header version.", ProgramFile);
     }
 
@@ -235,28 +237,88 @@ static unsigned char ReadProgramFile (void)
         SPAddr = Val;
     }
 
-    /* Get load address */
-    Val2 = 0; /* suppress uninitialized variable warning */
-    if (((Val = fgetc(F)) == EOF) ||
-        ((Val2 = fgetc(F)) == EOF)) {
-        Error ("'%s': Header missing load address", ProgramFile);
-    }
-    Load = Val | (Val2 << 8);
+    if (Version == HeaderVersion) {
+        /* Version 2: Single segment format */
+        /* Get load address */
+        Val2 = 0; /* suppress uninitialized variable warning */
+        if (((Val = fgetc(F)) == EOF) ||
+            ((Val2 = fgetc(F)) == EOF)) {
+            Error ("'%s': Header missing load address", ProgramFile);
+        }
+        Load = Val | (Val2 << 8);
 
-    /* Get reset address */
-    if (((Val = fgetc(F)) == EOF) ||
-        ((Val2 = fgetc(F)) == EOF)) {
-        Error ("'%s': Header missing reset address", ProgramFile);
-    }
-    Reset = Val | (Val2 << 8);
+        /* Get reset address */
+        if (((Val = fgetc(F)) == EOF) ||
+            ((Val2 = fgetc(F)) == EOF)) {
+            Error ("'%s': Header missing reset address", ProgramFile);
+        }
+        Reset = Val | (Val2 << 8);
 
-    /* Read the file body into memory */
-    Addr = Load;
-    while ((Val = fgetc(F)) != EOF) {
-        if (Addr >= PARAVIRT_BASE) {
-            Error ("'%s': To large to fit into $%04X-$%04X", ProgramFile, Addr, PARAVIRT_BASE);
+        /* Read the file body into memory */
+        Addr = Load;
+        while ((Val = fgetc(F)) != EOF) {
+            if (Addr >= PARAVIRT_BASE) {
+                Error ("'%s': To large to fit into $%04X-$%04X", ProgramFile, Addr, PARAVIRT_BASE);
+            }
+            MemWriteByte (Addr++, (unsigned char) Val);
+        }
+
+        Print (stderr, 1, "Loaded '%s' at $%04X-$%04X\n", ProgramFile, Load, Addr - 1);
+    } else {
+        /* Version 3: Multi-segment format */
+        unsigned SegCount, SegAddr, SegLen;
+        unsigned SegIdx;
+
+        /* Get reset address */
+        if (((Val = fgetc(F)) == EOF) ||
+            ((Val2 = fgetc(F)) == EOF)) {
+            Error ("'%s': Header missing reset address", ProgramFile);
+        }
+        Reset = Val | (Val2 << 8);
+
+        /* Get segment count */
+        if (((Val = fgetc(F)) == EOF) ||
+            ((Val2 = fgetc(F)) == EOF)) {
+            Error ("'%s': Header missing segment count", ProgramFile);
+        }
+        SegCount = Val | (Val2 << 8);
+
+        Print (stderr, 1, "Loading %u segment(s) from '%s'\n", SegCount, ProgramFile);
+
+        /* Load each segment */
+        for (SegIdx = 0; SegIdx < SegCount; ++SegIdx) {
+            /* Get segment load address */
+            if (((Val = fgetc(F)) == EOF) ||
+                ((Val2 = fgetc(F)) == EOF)) {
+                Error ("'%s': Segment %u missing load address", ProgramFile, SegIdx);
+            }
+            SegAddr = Val | (Val2 << 8);
+
+            /* Get segment length */
+            if (((Val = fgetc(F)) == EOF) ||
+                ((Val2 = fgetc(F)) == EOF)) {
+                Error ("'%s': Segment %u missing length", ProgramFile, SegIdx);
+            }
+            SegLen = Val | (Val2 << 8);
+
+            Print (stderr, 1, "  Segment %u: $%04X-$%04X (%u bytes)\n",
+                   SegIdx, SegAddr, SegAddr + SegLen - 1, SegLen);
+
+            /* Read segment data */
+            Addr = SegAddr;
+            while (SegLen > 0) {
+                if ((Val = fgetc(F)) == EOF) {
+                    Error ("'%s': Segment %u truncated (expected %u more bytes)",
+                           ProgramFile, SegIdx, SegLen);
+                }
+                if (Addr >= PARAVIRT_BASE) {
+                    Error ("'%s': Segment %u too large to fit into $%04X-$%04X",
+                           ProgramFile, SegIdx, Addr, PARAVIRT_BASE);
+                }
+                MemWriteByte (Addr++, (unsigned char) Val);
+                --SegLen;
+            }
         }
-        MemWriteByte (Addr++, (unsigned char) Val);
     }
 
     /* Check for errors */
@@ -267,7 +329,6 @@ static unsigned char ReadProgramFile (void)
     /* Close the file */
     fclose (F);
 
-    Print (stderr, 1, "Loaded '%s' at $%04X-$%04X\n", ProgramFile, Load, Addr - 1);
     Print (stderr, 1, "File version: %d\n", Version);
     Print (stderr, 1, "Reset: $%04X\n", Reset);
 
-- 
2.43.0

